/**
 * Fixes the ACPI battery status reporting method to report the current
 * discharging rate when running off battery.
 */

#define pr_fmt(fmt) KBUILD_MODNAME ": " fmt

#include <linux/kernel.h>
#include <linux/module.h>
#include <linux/acpi.h>

MODULE_AUTHOR("Peter Wu <peter@lekensteyn.nl>");
MODULE_DESCRIPTION("Fix battery discharge rate reporting for Clevo B7130.");
MODULE_LICENSE("GPL");
MODULE_VERSION("0.1");

static u8 batteryfix_aml[] = {
	0x53, 0x53, 0x44, 0x54, 0x5b, 0x01, 0x00, 0x00, 0x02, 0x79, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x42, 0x37, 0x31, 0x33, 0x30, 0x42, 0x41, 0x54,
	0x18, 0x03, 0x12, 0x20, 0x49, 0x4e, 0x54, 0x4c, 0x28, 0x05, 0x10, 0x20,
	0x14, 0x46, 0x13, 0x5c, 0x2f, 0x03, 0x5f, 0x53, 0x42, 0x5f, 0x42, 0x41,
	0x54, 0x30, 0x55, 0x50, 0x42, 0x53, 0x00, 0xa0, 0x4d, 0x11, 0x5e, 0x5e,
	0x2f, 0x04, 0x50, 0x43, 0x49, 0x30, 0x4c, 0x50, 0x43, 0x42, 0x45, 0x43,
	0x5f, 0x5f, 0x42, 0x41, 0x54, 0x30, 0x70, 0x00, 0x60, 0x70, 0x00, 0x61,
	0xa0, 0x41, 0x05, 0x5e, 0x5e, 0x2f, 0x04, 0x50, 0x43, 0x49, 0x30, 0x4c,
	0x50, 0x43, 0x42, 0x45, 0x43, 0x5f, 0x5f, 0x41, 0x44, 0x50, 0x5f, 0xa0,
	0x3a, 0x93, 0x7b, 0x5e, 0x5e, 0x2f, 0x04, 0x50, 0x43, 0x49, 0x30, 0x4c,
	0x50, 0x43, 0x42, 0x45, 0x43, 0x5f, 0x5f, 0x42, 0x53, 0x54, 0x30, 0x0a,
	0x02, 0x00, 0x0a, 0x02, 0x7d, 0x60, 0x0a, 0x02, 0x60, 0x7b, 0x5e, 0x5e,
	0x2f, 0x04, 0x50, 0x43, 0x49, 0x30, 0x4c, 0x50, 0x43, 0x42, 0x45, 0x43,
	0x5f, 0x5f, 0x42, 0x50, 0x52, 0x30, 0x0b, 0xff, 0xff, 0x61, 0xa1, 0x1e,
	0x7d, 0x60, 0x01, 0x60, 0x7b, 0x5e, 0x5e, 0x2f, 0x04, 0x50, 0x43, 0x49,
	0x30, 0x4c, 0x50, 0x43, 0x42, 0x45, 0x43, 0x5f, 0x5f, 0x42, 0x50, 0x52,
	0x30, 0x0b, 0xff, 0xff, 0x61, 0x7b, 0x61, 0x0b, 0x00, 0x80, 0x67, 0xa0,
	0x0e, 0x93, 0x67, 0x0b, 0x00, 0x80, 0x74, 0x0c, 0x00, 0x00, 0x01, 0x00,
	0x61, 0x61, 0x7b, 0x5e, 0x5e, 0x2f, 0x04, 0x50, 0x43, 0x49, 0x30, 0x4c,
	0x50, 0x43, 0x42, 0x45, 0x43, 0x5f, 0x5f, 0x42, 0x52, 0x43, 0x30, 0x0b,
	0xff, 0xff, 0x62, 0x7b, 0x5e, 0x5e, 0x2f, 0x04, 0x50, 0x43, 0x49, 0x30,
	0x4c, 0x50, 0x43, 0x42, 0x45, 0x43, 0x5f, 0x5f, 0x42, 0x50, 0x56, 0x30,
	0x0b, 0xff, 0xff, 0x63, 0x70, 0x60, 0x88, 0x50, 0x42, 0x53, 0x54, 0x00,
	0x00, 0x70, 0x61, 0x88, 0x50, 0x42, 0x53, 0x54, 0x01, 0x00, 0x70, 0x62,
	0x88, 0x50, 0x42, 0x53, 0x54, 0x0a, 0x02, 0x00, 0x70, 0x63, 0x88, 0x50,
	0x42, 0x53, 0x54, 0x0a, 0x03, 0x00, 0xa0, 0x22, 0x92, 0x93, 0x42, 0x46,
	0x43, 0x43, 0x5e, 0x5e, 0x2f, 0x04, 0x50, 0x43, 0x49, 0x30, 0x4c, 0x50,
	0x43, 0x42, 0x45, 0x43, 0x5f, 0x5f, 0x42, 0x46, 0x43, 0x30, 0x86, 0x42,
	0x41, 0x54, 0x30, 0x0a, 0x81, 0xa1, 0x05, 0x49, 0x56, 0x42, 0x53
};

static int __init clevo_battery_fix_init(void) {
	acpi_status status;

	status = acpi_install_method(batteryfix_aml);
	if (ACPI_FAILURE(status))
		return -EINVAL;

	pr_info("Clevo battery fix patch applied.\n");
	return 0;
}

static void __exit clevo_battery_fix_exit(void) {
	// TODO: maybe undo change?
	pr_info("Clevo battery fix patch unloaded.\n");
}

module_init(clevo_battery_fix_init);
module_exit(clevo_battery_fix_exit);
/* vim: set ts=8 noet sw=8: */
